Техническое задание: Telegram WebApp для чтения книг
1. Общее описание
Telegram WebApp приложение для чтения электронных книг с поддержкой поиска на Флибусте, персональной библиотекой, системой закладок и режимом скорочтения Spritz.

2. Технологический стек
КомпонентТехнологияFrontendReact (JSX), Tailwind CSSBackendFastAPI, Python, venvБаза данныхSQLiteИнфраструктураDocker, Docker ComposeПлатформаTelegram WebApp (запуск через бота)Язык интерфейсаРусский

3. Требования к коду

Принципы DRY, ООП
Маппинг данных где необходимо
Минимум комментариев
Максимальная декомпозиция на компоненты
Грамотная файловая структура
Безопасность (валидация, санитизация, защита от инъекций)
Документация только по запросу


4. Функциональные модули
4.1. Главная страница (Библиотека)
Отображение:

Список всех книг в библиотеке пользователя
Блок "Читаю сейчас" — книги с прогрессом чтения (процент/страница)
Обложки, названия, авторы

Поиск:

Единое поле поиска по названию/автору
Поиск по локальной библиотеке (уже добавленные книги)
Поиск на Флибусте (.onion) через backend-прокси
Результаты: найденные .fb2 файлы с возможностью скачать и добавить в библиотеку


4.2. Читалка (страница книги)
Основной функционал:

Отображение текста книги с разбивкой на страницы/главы
Парсинг .fb2 формата
Сохранение позиции чтения

Настройки отображения:

Шрифт (выбор из списка)
Размер шрифта
Интерлиньяж (межстрочный интервал)
Расстояние между абзацами

Закладки:

Добавить текущую страницу в закладки
Добавить комментарий к закладке
Быстрый переход по закладкам


4.3. Режим Spritz (скорочтение)
Функционал:

Пословное отображение текста с фокусной точкой
Настройка скорости (слов в минуту)
Настройка размера шрифта
Кнопки: Play / Pause
Сохранение прогресса при паузе и выходе

Логика:

Старт с первого слова текущей страницы
При выходе — позиция книги синхронизируется с прогрессом Spritz
При окончании главы — пауза, уведомление "Глава окончена", кнопка "Следующая глава"

Статистика:

Учёт прочитанных блоков текста со скоростью
Расчёт средней скорости чтения Spritz


4.4. Личный кабинет
Авторизация:

Автоматическая через Telegram WebApp (initData)
Привязка к Telegram ID пользователя

Статистика чтения:

Количество прочитанных книг
Количество книг в процессе
Всего прочитано страниц
Средняя скорость Spritz

Цели:

Установка цели чтения (книг/страниц в месяц)
Отображение прогресса к цели

Страница закладок:

Список всех закладок пользователя
Поиск по закладкам (по комментариям, названию книги)
Переход к закладке в книге


5. Интеграции
5.1. Telegram Bot

Команда /start — открытие WebApp
Передача initData для авторизации

5.2. Флибуста (.onion)

Backend-прокси для поиска книг
Парсинг результатов поиска
Скачивание .fb2 файлов
Требуется Tor-прокси на сервере


6. Модель данных (основные сущности)
User
├── telegram_id
├── username
├── reading_goal
└── created_at

Book
├── title
├── author
├── file_path (.fb2)
├── cover_path
└── total_pages

UserBook (связь user-book)
├── user_id
├── book_id
├── current_position
├── progress_percent
├── status (reading/finished/planned)
└── started_at / finished_at

Bookmark
├── user_book_id
├── position
├── comment
└── created_at

ReadingSession (для статистики Spritz)
├── user_book_id
├── words_count
├── speed_wpm
├── duration_seconds
└── created_at

UserSettings
├── user_id
├── font_family
├── font_size
├── line_height
├── paragraph_spacing
└── spritz_speed

7. Структура проекта (предварительная)
book-reader/
├── docker-compose.yml
├── frontend/
│   ├── Dockerfile
│   ├── src/
│   │   ├── components/
│   │   │   ├── common/
│   │   │   ├── library/
│   │   │   ├── reader/
│   │   │   ├── spritz/
│   │   │   └── profile/
│   │   ├── pages/
│   │   ├── hooks/
│   │   ├── services/
│   │   ├── utils/
│   │   └── App.jsx
│   └── package.json
├── backend/
│   ├── Dockerfile
│   ├── app/
│   │   ├── api/
│   │   │   └── routes/
│   │   ├── core/
│   │   ├── models/
│   │   ├── services/
│   │   ├── repositories/
│   │   └── main.py
│   └── requirements.txt
└── data/
    ├── books/
    └── database.db

8. Нефункциональные требования

Адаптивный интерфейс под мобильные устройства
Оффлайн-режим чтения (кэширование книг)
Быстрая загрузка страниц (< 2 сек)
Защита API (валидация Telegram initData)


Готов приступить к реализации. С чего начнём — backend, frontend, или docker-инфраструктура?Добавь еще возможность тестирования на локальной машине, чтобы не запускать для отладки телеграм19:24Разработал стратегию локального тестирования без Telegram интеграции.Пользователь хочет добавить в ТЗ возможность локального тестирования без Telegram. Это разумное требование для разработки - нужно иметь возможность запускать и тестировать приложение локально без необходимости каждый раз деплоить в Telegram WebApp.
Нужно добавить:

Мок для Telegram WebApp API
Режим разработки с тестовым пользователем
Переключение между режимами (dev/prod)
Возможно отдельный docker-compose для разработки
Техническое задание: Telegram WebApp для чтения книг (v1.1)
1. Общее описание
Telegram WebApp приложение для чтения электронных книг с поддержкой поиска на Флибусте, персональной библиотекой, системой закладок и режимом скорочтения Spritz.

2. Технологический стек
КомпонентТехнологияFrontendReact (JSX), Tailwind CSSBackendFastAPI, Python, venvБаза данныхSQLiteИнфраструктураDocker, Docker ComposeПлатформаTelegram WebApp (запуск через бота)Язык интерфейсаРусский

3. Требования к коду

Принципы DRY, ООП
Маппинг данных где необходимо
Минимум комментариев
Максимальная декомпозиция на компоненты
Грамотная файловая структура
Безопасность (валидация, санитизация, защита от инъекций)
Документация только по запросу


4. Режимы запуска
4.1. Development Mode (локальная разработка)
Особенности:

Запуск без Telegram (в обычном браузере)
Мок Telegram WebApp API
Автоматический тестовый пользователь
Hot-reload для frontend и backend
Отключенная валидация initData
Debug-панель с информацией о состоянии

Конфигурация:
ENV=development
DEBUG=true
SKIP_TG_VALIDATION=true
TEST_USER_ID=123456789
TEST_USERNAME=dev_user
Запуск:
bashdocker-compose -f docker-compose.dev.yml up
# или без Docker:
# backend: uvicorn app.main:app --reload
# frontend: npm run dev
```

**Доступ:**
- Frontend: `http://localhost:5173`
- Backend API: `http://localhost:8000`
- API Docs: `http://localhost:8000/docs`

### 4.2. Production Mode (Telegram)

**Особенности:**
- Полная валидация Telegram initData
- Авторизация только через Telegram
- Оптимизированная сборка
- HTTPS обязателен

**Конфигурация:**
```
ENV=production
DEBUG=false
SKIP_TG_VALIDATION=false
TG_BOT_TOKEN=<token>
Запуск:
bashdocker-compose up -d
```

---

## 5. Функциональные модули

### 5.1. Главная страница (Библиотека)

**Отображение:**
- Список всех книг в библиотеке пользователя
- Блок "Читаю сейчас" — книги с прогрессом чтения (процент/страница)
- Обложки, названия, авторы

**Поиск:**
- Единое поле поиска по названию/автору
- Поиск по локальной библиотеке (уже добавленные книги)
- Поиск на Флибусте (.onion) через backend-прокси
- Результаты: найденные .fb2 файлы с возможностью скачать и добавить в библиотеку

---

### 5.2. Читалка (страница книги)

**Основной функционал:**
- Отображение текста книги с разбивкой на страницы/главы
- Парсинг .fb2 формата
- Сохранение позиции чтения

**Настройки отображения:**
- Шрифт (выбор из списка)
- Размер шрифта
- Интерлиньяж (межстрочный интервал)
- Расстояние между абзацами

**Закладки:**
- Добавить текущую страницу в закладки
- Добавить комментарий к закладке
- Быстрый переход по закладкам

---

### 5.3. Режим Spritz (скорочтение)

**Функционал:**
- Пословное отображение текста с фокусной точкой
- Настройка скорости (слов в минуту)
- Настройка размера шрифта
- Кнопки: Play / Pause
- Сохранение прогресса при паузе и выходе

**Логика:**
- Старт с первого слова текущей страницы
- При выходе — позиция книги синхронизируется с прогрессом Spritz
- При окончании главы — пауза, уведомление "Глава окончена", кнопка "Следующая глава"

**Статистика:**
- Учёт прочитанных блоков текста со скоростью
- Расчёт средней скорости чтения Spritz

---

### 5.4. Личный кабинет

**Авторизация:**
- Production: через Telegram WebApp (initData)
- Development: автоматический тестовый пользователь

**Статистика чтения:**
- Количество прочитанных книг
- Количество книг в процессе
- Всего прочитано страниц
- Средняя скорость Spritz

**Цели:**
- Установка цели чтения (книг/страниц в месяц)
- Отображение прогресса к цели

**Страница закладок:**
- Список всех закладок пользователя
- Поиск по закладкам (по комментариям, названию книги)
- Переход к закладке в книге

---

## 6. Интеграции

### 6.1. Telegram Bot
- Команда /start — открытие WebApp
- Передача initData для авторизации

### 6.2. Флибуста (.onion)
- Backend-прокси для поиска книг
- Парсинг результатов поиска
- Скачивание .fb2 файлов
- Требуется Tor-прокси на сервере (в dev-режиме можно использовать мок или публичное зеркало)

---

## 7. Модель данных (основные сущности)
```
User
├── telegram_id
├── username
├── reading_goal
└── created_at

Book
├── title
├── author
├── file_path (.fb2)
├── cover_path
└── total_pages

UserBook (связь user-book)
├── user_id
├── book_id
├── current_position
├── progress_percent
├── status (reading/finished/planned)
└── started_at / finished_at

Bookmark
├── user_book_id
├── position
├── comment
└── created_at

ReadingSession (для статистики Spritz)
├── user_book_id
├── words_count
├── speed_wpm
├── duration_seconds
└── created_at

UserSettings
├── user_id
├── font_family
├── font_size
├── line_height
├── paragraph_spacing
└── spritz_speed
```

---

## 8. Структура проекта
```
book-reader/
├── docker-compose.yml          # Production
├── docker-compose.dev.yml      # Development
├── .env.example
├── frontend/
│   ├── Dockerfile
│   ├── Dockerfile.dev
│   ├── src/
│   │   ├── components/
│   │   │   ├── common/
│   │   │   ├── library/
│   │   │   ├── reader/
│   │   │   ├── spritz/
│   │   │   ├── profile/
│   │   │   └── dev/            # DevPanel, MockIndicator
│   │   ├── pages/
│   │   ├── hooks/
│   │   ├── services/
│   │   │   └── telegram.js     # TG API + mock
│   │   ├── utils/
│   │   ├── mocks/              # Telegram WebApp mock
│   │   └── App.jsx
│   └── package.json
├── backend/
│   ├── Dockerfile
│   ├── Dockerfile.dev
│   ├── app/
│   │   ├── api/
│   │   │   └── routes/
│   │   ├── core/
│   │   │   ├── config.py       # Settings с переключением режимов
│   │   │   └── auth.py         # Валидация + dev-bypass
│   │   ├── models/
│   │   ├── services/
│   │   ├── repositories/
│   │   └── main.py
│   └── requirements.txt
└── data/
    ├── books/
    └── database.db

9. Telegram WebApp Mock (для dev-режима)
javascript// frontend/src/mocks/telegramWebApp.js
window.Telegram = {
  WebApp: {
    initData: 'dev_mode',
    initDataUnsafe: {
      user: {
        id: 123456789,
        first_name: 'Dev',
        last_name: 'User',
        username: 'dev_user'
      }
    },
    ready: () => console.log('[Mock] TG WebApp ready'),
    expand: () => console.log('[Mock] TG WebApp expand'),
    close: () => console.log('[Mock] TG WebApp close'),
    MainButton: {
      show: () => {},
      hide: () => {},
      setText: (text) => console.log('[Mock] MainButton:', text),
      onClick: (cb) => {}
    },
    BackButton: {
      show: () => {},
      hide: () => {},
      onClick: (cb) => {}
    },
    themeParams: {
      bg_color: '#ffffff',
      text_color: '#000000',
      hint_color: '#999999',
      button_color: '#3390ec',
      button_text_color: '#ffffff'
    },
    colorScheme: 'light'
  }
};

10. Нефункциональные требования

Адаптивный интерфейс под мобильные устройства
Оффлайн-режим чтения (кэширование книг)
Быстрая загрузка страниц (< 2 сек)
Защита API (валидация Telegram initData в production)
Удобная локальная разработка без внешних зависимостей


11. Dev-панель (только в development)
Отображается в углу экрана, показывает:

Текущий режим (DEV)
ID тестового пользователя
Быстрые действия: сброс БД, смена пользователя, очистка кэша
Лог API-запросов

